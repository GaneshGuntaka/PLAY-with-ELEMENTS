<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Reaction - PLAY with ELEMENTS</title>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap');

    :root{
      --bg: #fff8fb;
      --card: #fff1f6;
      --muted: #745a63;
      --accent: #ff7da6;
      --accent-2: #ffd7e1;
      --glass: rgba(255,255,255,0.7);
      --beaker: #fff7ff;
    }

    html,body{height:100%; margin:0; font-family:'Poppins',sans-serif; background: linear-gradient(180deg,var(--bg),#fff); color:#2c2c2c;}
    .wrap{
      max-width:980px;
      margin:28px auto;
      padding:22px;
    }

    header.top {
      display:flex;
      align-items:center;
      gap:18px;
      margin-bottom:12px;
    }
    header.top h1{
      margin:0;
      font-size:1.4rem;
      font-weight:700;
    }
    header.top .sub{
      color:var(--muted);
      font-weight:500;
      font-size:0.95rem;
    }

    .stage {
      display:flex;
      gap:24px;
      align-items:flex-start;
      margin-top:18px;
      flex-wrap:wrap;
    }

    /* left column: beaker + animation */
    .beaker-area {
      flex:0 1 520px;
      min-height:420px;
      background: linear-gradient(180deg, rgba(255,245,249,0.85), rgba(255,250,250,0.6));
      border-radius:14px;
      padding:18px;
      box-shadow: 0 8px 22px rgba(40,20,30,0.06);
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:flex-start;
    }

    .beaker-wrap {
      position:relative;
      width:320px;
      height:320px;
      margin-top:8px;
    }

    /* beaker visual */
    .beaker {
      position:absolute;
      bottom:0;
      left:50%;
      transform:translateX(-50%);
      width:220px;
      height:220px;
      border-radius: 0 0 36% 36% / 0 0 18% 18%;
      background: linear-gradient(180deg,#ffffff,#fff7ff);
      border: 6px solid rgba(255,200,220,0.9);
      box-shadow: 0 12px 30px rgba(40,20,30,0.06);
      overflow:hidden;
    }

    /* liquid inside the beaker */
    .liquid {
      position:absolute;
      bottom:0;
      left:0;
      width:100%;
      height:0%;
      background: linear-gradient(180deg,#ffd8e6,#ffb0c9);
      transition: height 900ms ease, background 1200ms ease;
      display:flex;
      align-items:flex-end;
      justify-content:center;
      overflow:visible;
    }

    /* bubbles */
    .bubble {
      position:absolute;
      bottom:12px;
      width:12px;
      height:12px;
      border-radius:50%;
      background:rgba(255,255,255,0.9);
      opacity:0.9;
      transform: translateY(0);
      animation: floatUp 2.5s linear infinite;
    }
    @keyframes floatUp {
      0% { transform: translateY(0) scale(0.9); opacity:0.9; }
      100% { transform: translateY(-220px) scale(1.2); opacity:0; }
    }

    /* animated element tokens that drop */
    .token {
      position:absolute;
      top: -40px;
      left: 50%;
      transform: translateX(-50%) scale(1);
      background: #fff;
      border-radius:10px;
      padding:10px 12px;
      border: 1px solid rgba(200,180,190,0.9);
      font-weight:700;
      box-shadow: 0 6px 18px rgba(40,20,30,0.08);
      transition: transform 600ms ease, opacity 400ms ease;
      z-index:20;
      display:flex;
      align-items:center;
      justify-content:center;
    }

    /* small description right column */
    .info {
      flex: 1 1 320px;
      min-height:320px;
      background: var(--card);
      border-radius:12px;
      padding:14px;
      box-shadow: 0 6px 18px rgba(40,20,30,0.06);
    }

    .info h2 { margin:0 0 8px 0; font-size:1.1rem; }
    .info p { color:var(--muted); margin:8px 0 12px 0; font-size:0.95rem; }
    .controls { display:flex; gap:10px; margin-top:12px; flex-wrap:wrap; }

    .result-card {
      margin-top:12px;
      background: white;
      border-radius:10px;
      padding:12px;
      box-shadow:0 6px 14px rgba(40,20,30,0.04);
    }

    .product {
      display:flex;
      gap:12px;
      align-items:center;
      justify-content:flex-start;
    }
    .product .icon {
      width:72px;height:72px;border-radius:10px;background:linear-gradient(180deg,#fff1f6,#ffeaf0);display:flex;align-items:center;justify-content:center;font-weight:800;font-size:1.4rem;color:#a33;
      border:1px solid rgba(200,180,190,0.6);
    }
    .product .meta { font-weight:600; color:#2c2c2c; }

    /* footer small */
    .small { font-size:0.85rem; color:var(--muted); margin-top:8px; }

    /* animation helpers for pop */
    .reaction-puff {
      position:absolute;
      bottom:110px;
      left:50%;
      transform:translateX(-50%);
      font-size:48px;
      opacity:0;
      filter: drop-shadow(0 8px 20px rgba(255,120,150,0.18));
      transition: opacity 300ms ease, transform 350ms ease;
      z-index:30;
    }

    /* disabled buttons style */
    .btn {
      background: linear-gradient(180deg,var(--accent), #ff5c8c);
      color:white;
      border:none;
      padding:10px 14px;
      font-weight:600;
      border-radius:10px;
      cursor:pointer;
      box-shadow: 0 6px 18px rgba(255,125,160,0.12);
    }
    .btn:disabled { background:var(--accent-2); color:#a07a86; cursor:not-allowed; box-shadow:none; }

    @media (max-width:880px){
      .stage { flex-direction:column; align-items:center; }
      .beaker-area { width:100%; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header class="top">
      <div>
        <h1>PLAY with ELEMENTS</h1>
        <div class="sub">Reaction Lab ‚Äî mix selected elements and watch what happens!</div>
      </div>
      <div style="margin-left:auto; display:flex; gap:10px; align-items:center;">
        <button class="btn" style="background:transparent;color:var(--muted); box-shadow:none; border:1px solid rgba(200,180,190,0.6);" onclick="location.href='periodic.html'">Back to Table</button>
        <button class="btn" style="background:transparent;color:var(--muted); box-shadow:none; border:1px solid rgba(200,180,190,0.6);" onclick="location.href='index.html'">Home</button>
      </div>
    </header>

    <section class="stage">
      <div class="beaker-area">
        <div style="font-weight:600; color:var(--muted)">Beaker</div>
        <div class="beaker-wrap" id="beakerWrap">
          <div class="beaker" id="beaker">
            <div class="liquid" id="liquid"></div>
            <!-- tokens and bubbles will be appended here -->
            <div class="reaction-puff" id="puff">‚ú®</div>
          </div>
        </div>

        <div class="small" id="statusText">Waiting for elements...</div>
      </div>

      <div class="info">
        <h2>Selected Elements</h2>
        <p id="selElements">‚Äî</p>
        <div class="controls">
          <button class="btn" id="startBtn" disabled>Start Reaction</button>
          <button class="btn" id="saveBtn" disabled>Save to History</button>
          <button class="btn" id="againBtn" style="background:transparent;color:var(--muted); border:1px solid rgba(200,180,190,0.6);" onclick="playAgain()">Play Again</button>
        </div>

        <div class="result-card" id="resultCard" style="display:none;">
          <div style="display:flex; justify-content:space-between; align-items:center;">
            <div>
              <div style="font-size:0.85rem; color:var(--muted)">Reaction result</div>
              <div id="resultTitle" style="font-weight:700; font-size:1.05rem; margin-top:6px;">‚Äî</div>
            </div>
            <div class="product">
              <div class="icon" id="productIcon">?</div>
            </div>
          </div>
          <div style="margin-top:10px; color:var(--muted)" id="resultDesc">‚Äî</div>
        </div>

        <div class="small" style="margin-top:14px">Tip: you can select elements in the periodic table; clicking Next there and returning here will show them and animate the mix.</div>
      </div>
    </section>
  </div>

  <script>
    // Read selected elements from localStorage (set by periodic.html)
    let selected = [];
    try {
      const raw = localStorage.getItem('selectedElements');
      if(raw) selected = JSON.parse(raw);
    } catch(e) {
      selected = [];
    }

    const selEl = document.getElementById('selElements');
    const startBtn = document.getElementById('startBtn');
    const saveBtn = document.getElementById('saveBtn');
    const statusText = document.getElementById('statusText');
    const liquid = document.getElementById('liquid');
    const beaker = document.getElementById('beaker');
    const beakerWrap = document.getElementById('beakerWrap');
    const puff = document.getElementById('puff');
    const resultCard = document.getElementById('resultCard');
    const resultTitle = document.getElementById('resultTitle');
    const resultDesc = document.getElementById('resultDesc');
    const productIcon = document.getElementById('productIcon');

    // Reaction database (demo). Keys are sorted symbols joined by '+'
    // Feel free to expand this mapping later.
    const reactions = {
      // binary examples
      'H+O': { product: 'H‚ÇÇO', name: 'Water', desc: 'Hydrogen and oxygen combine to form water (simplified).', color: '#b8ecff', icon: 'üíß' },
      'Na+Cl': { product: 'NaCl', name: 'Sodium chloride (salt)', desc: 'Sodium metal reacts with chlorine gas to form common salt.', color: '#fff3c4', icon: 'üßÇ' },
      'H+Cl': { product: 'HCl', name: 'Hydrogen chloride', desc: 'Hydrogen and chlorine form hydrogen chloride (acid in water).', color: '#fbe6f0', icon: '‚öóÔ∏è' },
      'Fe+O': { product: 'Fe‚ÇÇO‚ÇÉ', name: 'Iron(III) oxide (rust)', desc: 'Iron oxidizes in presence of oxygen to form rust (iron oxide).', color: '#f4d3d3', icon: 'ü™®' },
      'C+O': { product: 'CO‚ÇÇ', name: 'Carbon dioxide', desc: 'Carbon burns in oxygen to form carbon dioxide gas.', color: '#dfefff', icon: 'üí®' },
      'Cu+S': { product: 'CuS', name: 'Copper(II) sulfide', desc: 'Copper reacts with sulfur to form copper sulfide (demo).', color: '#e6f6ff', icon: 'üî∑' },
      // ternary example (simple)
      'Na+H+Cl': { product: 'Na + HCl (acid+salt demo)', name: 'Acid + Salt demo', desc: 'Sodium and hydrogen + chlorine in combination ‚Äî demo mapping.', color: '#ffe6f0', icon: 'üî¨' }
    };

    // Utility: build key from selected array independent of order (sort alpha)
    function reactionKey(arr) {
      return arr.slice().sort().join('+');
    }

    // Show selected elements list
    function renderSelection() {
      if(!selected || selected.length === 0) {
        selEl.textContent = 'No elements selected. Go back to the periodic table and choose 2 or more.';
        startBtn.disabled = true;
        statusText.textContent = 'No elements to mix.';
      } else {
        selEl.textContent = selected.join(' + ');
        startBtn.disabled = selected.length < 2;
        statusText.textContent = selected.length >= 2 ? 'Ready to start the reaction.' : 'Select at least 2 elements to begin.';
      }
    }

    renderSelection();

    // Animation sequence:
    // 1) drop tokens into beaker, one by one
    // 2) each drop increases liquid level and may spawn bubble
    // 3) when done, trigger reaction effect (puff + color change)
    // 4) show result
    startBtn.addEventListener('click', () => {
      startBtn.disabled = true;
      saveBtn.disabled = true;
      resultCard.style.display = 'none';
      statusText.textContent = 'Mixing...';
      performMixAnimation(selected).then(result => {
        showResult(result);
        saveBtn.disabled = false;
      });
    });

    // Save to history (localStorage). Stores {time, selected, result}
    saveBtn.addEventListener('click', () => {
      const key = reactionKey(selected);
      const res = lookupReaction(selected);
      const entry = {
        time: new Date().toISOString(),
        selected: selected.slice(),
        result: res.product || 'Unknown',
        name: res.name || 'Unknown'
      };
      let hist = [];
      try { hist = JSON.parse(localStorage.getItem('reactionHistory') || '[]'); } catch(e) { hist = []; }
      hist.unshift(entry);
      localStorage.setItem('reactionHistory', JSON.stringify(hist.slice(0,50))); // keep 50
      alert('Saved to history!');
    });

    // Play again
    function playAgain(){
      window.location.href = 'periodic.html';
    }

    // Simple lookup
    function lookupReaction(arr){
      const key = reactionKey(arr);
      return reactions[key] || {};
    }

    // Function: animate dropping tokens and mixing
    async function performMixAnimation(arr){
      // clear any existing tokens/bubbles
      const existing = beaker.querySelectorAll('.token, .bubble');
      existing.forEach(e => e.remove());
      liquid.style.height = '4%';
      liquid.style.background = 'linear-gradient(180deg,#ffd8e6,#ffb0c9)';
      puff.style.opacity = 0;

      // drop each selected element token one by one
      for(let i=0;i<arr.length;i++){
        const sym = arr[i];
        await dropToken(sym, i, arr.length);
        // after each drop increase liquid level slightly
        const level = Math.min(8 + ((i+1) * (62 / arr.length)), 78);
        liquid.style.height = level + '%';

        // spawn a few bubbles
        spawnBubbles(Math.min(4, 1 + Math.floor(i/1)));
        await wait(650);
      }

      // slight pause
      await wait(600);

      // reaction lookup
      const lookup = lookupReaction(arr);

      // reaction burst
      if(lookup && lookup.product){
        // color-change to lookup.color
        liquid.style.background = `linear-gradient(180deg, ${lookup.color}, ${shadeColor(lookup.color, -20)})`;
        // puff and sparkle
        await showPuff('‚ú®');
        await wait(600);
        return lookup;
      } else {
        // unknown reaction ‚Äî fizzing and smoke
        await showPuff('üí•');
        // change color to a noisy mixed color
        liquid.style.background = `linear-gradient(180deg,#fff1d6,#ffe6f0)`;
        await wait(700);
        return { product: 'Unknown', name:'Mysterious Reaction', desc: 'No known mapping for this combination ‚Äî demo fizz & smoke.' };
      }
    }

    // Drop a single token animation
    function dropToken(sym, index, total) {
      return new Promise(resolve => {
        const token = document.createElement('div');
        token.className = 'token';
        token.style.left = (42 + (index * 28) - (total*8)) + 'px'; // spread horizontally a little
        token.textContent = sym;
        // start above beakerWrap
        beakerWrap.appendChild(token);
        // animate: drop into the beaker inner area
        // compute destination: inside beaker bottom offset
        const dropDuration = 650 + (index * 140);
        // initial position
        token.style.top = '-40px';
        token.style.opacity = '1';
        // animate to center-bottom of beaker using transform
        setTimeout(() => {
          token.style.transition = `top ${dropDuration}ms cubic-bezier(.2,.9,.2,1), transform 350ms ease`;
          token.style.top = '170px'; // a coordinate that looks like inside beaker
        }, 40);

        // when drop is "done"
        setTimeout(() => {
          // small pop and fade
          token.style.transform = 'scale(0.92)';
          token.style.opacity = '0.9';
          // leave a small floating label inside liquid
          const little = document.createElement('div');
          little.style.position = 'absolute';
          little.style.left = token.style.left;
          little.style.bottom = (8 + (index*3)) + 'px';
          little.style.transform = 'translateX(-50%)';
          little.textContent = sym;
          little.style.fontWeight = '700';
          little.style.opacity = '0.9';
          little.style.fontSize = '12px';
          liquid.appendChild(little);

          // remove token after a short delay
          setTimeout(() => {
            try{ token.remove(); }catch(e){}
            resolve();
          }, 280);
        }, dropDuration + 50);
      });
    }

    // spawn n bubbles inside the beaker at random horizontal positions
    function spawnBubbles(n){
      for(let i=0;i<n;i++){
        const bubble = document.createElement('div');
        bubble.className = 'bubble';
        const left = 30 + Math.random() * 160;
        bubble.style.left = left + 'px';
        bubble.style.width = (6 + Math.random()*18) + 'px';
        bubble.style.height = bubble.style.width;
        bubble.style.bottom = (12 + Math.random()*30) + 'px';
        bubble.style.animationDuration = (1.4 + Math.random()*1.6) + 's';
        beaker.appendChild(bubble);
        // remove after animation
        setTimeout(() => { bubble.remove(); }, 2400 + Math.random()*800);
      }
    }

    // show puff (emoji) animation
    function showPuff(symbol){
      return new Promise(resolve => {
        puff.textContent = symbol;
        puff.style.opacity = 1;
        puff.style.transform = 'translateX(-50%) scale(1.05)';
        setTimeout(() => {
          puff.style.transform = 'translateX(-50%) scale(1.25)';
          puff.style.opacity = 0;
        }, 520);
        setTimeout(() => { resolve(); }, 900);
      });
    }

    // show result in the right panel
    function showResult(obj){
      resultCard.style.display = 'block';
      resultTitle.textContent = obj.product ? `${obj.product} ‚Äî ${obj.name || ''}` : (obj.name || 'Unknown product');
      resultDesc.textContent = obj.desc || 'This reaction produced an unexpected result (demo).';
      productIcon.textContent = obj.icon || 'üî¨';
      statusText.textContent = 'Reaction complete';
    }

    // small helpers
    function wait(ms){ return new Promise(res => setTimeout(res, ms)); }

    // color shading helper: simple hex or rgb parse (supports #rrggbb)
    function shadeColor(hex, percent) {
      try {
        let c = hex.replace('#','');
        if(c.length === 3) c = c.split('').map(ch=>ch+ch).join('');
        const num = parseInt(c,16);
        let r = (num >> 16) + percent;
        let g = ((num >> 8) & 0x00FF) + percent;
        let b = (num & 0x0000FF) + percent;
        r = Math.max(0, Math.min(255, r));
        g = Math.max(0, Math.min(255, g));
        b = Math.max(0, Math.min(255, b));
        return '#' + ( (1<<24) + (r<<16) + (g<<8) + b ).toString(16).slice(1);
      } catch(e) {
        return hex;
      }
    }

    // Allow starting automatically if there are selected elements and user wants quick demo
    if(selected && selected.length >= 2){
      // enable start button
      startBtn.disabled = false;
      saveBtn.disabled = true;
      statusText.textContent = 'Ready to start the reaction.';
    }

    // If there's a known quick match, show it on the panel (but wait for user to press Start)
    const known = lookupReaction(selected);
    if(known && known.product){
      // prefill result preview
      resultTitle.textContent = known.product + ' ‚Äî ' + (known.name || '');
      resultDesc.textContent = known.desc || '';
      productIcon.textContent = known.icon || 'üî¨';
      resultCard.style.display = 'block';
      saveBtn.disabled = false;
    }

    // If user didn't come from periodic (no selection), let them pick a sample set (demo)
    if(!selected || selected.length < 2){
      // suggest a sample set and enable Start with demo pair
      statusText.textContent = 'No or too few elements selected. Using demo pair H + O.';
      selected = ['H','O']; // demo fallback
      renderSelection();
      startBtn.disabled = false;
    }

    // Ensure selElements text shows current selection
    function renderSelection(){ selEl.textContent = (selected && selected.length) ? selected.join(' + ') : '‚Äî'; }
    renderSelection();

  </script>
</body>
</html>
